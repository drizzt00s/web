var utility = require('utlity.js');
var fs = require("fs");
var user = require("moduleUser");


exports.loadProof = function(req, res){
	//查询credits表,返回数据给业务人员操作
	var queryString="select username,identitycard,income,drive,gangao,housing from credits";
	var client=utility.prepareDb();
	client.query(queryString,function(e,r){
		if(e){
			throw e;
		}
		var storeAll=[];
		for(var i=0;i<r.length;i++){
			var store={};
			for(var j in r[i]){
				if(r[i][j]!==-1&&r[i][j]!==1){
					store[j]=r[i][j];
				}
			}
			storeAll.push(store);
		}
		var storePicUrl=[];
		for(var l=0;l<storeAll.length;l++){
			for(var k in storeAll[l]){
				if(k == "username"){
					var username=storeAll[l][k];
				} else {
					var picUrl="./uploads/proofPic/"+k+"/"+username;
					var picArray=fs.readdirSync(picUrl); //此处逻辑有问题
					var picProof=picArray[0]
					storeAll[l][k]="../uploads/proofPic/"+k+"/"+username+"/"+picProof;
				}
			}
		}
		res.send(storeAll);
	});
};

exports.getProofValidationPage = function(req, res){
	res.render("proofValidation.ejs",{"title":"证件审核"});
};
exports.vlidateProofs = function(req, res){
	var operation=req.params.operationType;
	if(operation=="approveProof"){
		var approveWhom=req.body.d.approveWhom;
		var approveType=req.body.d.approveType;
		var client=utility.prepareDb();
		if(approveType=="identitycard"){
			var queryString="select pending from credits where username='"+approveWhom+"'";
			client.query(queryString,function(e,r){
				if(e){
					throw e;
				}
				var currentPending= eval("("+r[0]["pending"]+")");
				if(currentPending.length===0){
					var queryString="update credits set "+approveType+"=1,level=1,identity=1"+" where username='"+approveWhom+"'";
					client.query(queryString,function(e,r){
						if(e){
							throw e;
						}
						res.send("1");
					});
				}
				else{
					var indexFlag=0;
					recurUpdate(res);
					function recurUpdate(resObject){
						if(indexFlag===currentPending.length){
							//这里要改变用户认证等级字段credits.level
							var pendingLength=currentPending.length;
							var level=pendingLength+1;
							var queryString="update credits set pending='[]',"+approveType+"=1,level="+level+",identity=1 where username='"+approveWhom+"'";
							client.query(queryString,function(e){
								if(e){
									throw e;
								}
								resObject.send("1");
							});
							return false;
						}
						var queryString="update credits set "+currentPending[indexFlag]+"=1";
						client.query(queryString,function(e){
							if(e){
								throw e;
							}
							indexFlag++;
							recurUpdate(res);
						});
					}//recurUpdate
				}
			});
		} else {
			var queryString="select level from credits where username='"+approveWhom+"'";
			var client=utility.prepareDb();
			client.query(queryString,function(e,r){
				if(e){
					throw e;
				}
				var level=r[0]["level"];
				if(level>=1){
					//用户的身份证已经经过认证
					level+=1;
					var queryString="update credits set "+approveType+"=1"+",level="+level+" where username='"+approveWhom+"'";
					client.query(queryString,function(e){
						if(e){
							throw e;
						}
						res.send("1");
					});
				}
				else{
					//用户的身份证没有经过认证,这种情况要跟新credits.pending字段
					var queryString="select pending from credits where username='"+approveWhom+"'";
					client.query(queryString,function(e,r){
						if(e){
							throw e;
						}
						var currentPending= eval("("+r[0]["pending"]+")");
						currentPending.push(approveType);
						var currentPending=utility.removeRedundant(currentPending);
						var updatedPedning=JSON.stringify(currentPending);
						var queryString="update credits set pending='"+updatedPedning+"'"+"where username='"+approveWhom+"'" ;
						client.query(queryString,function(e,r){
							if(e){
								throw e;
							}
							res.send("1");
							//credits.pending字段字段更新完毕,但是身份证还没有验证
						});
					});
				}
			});
		}
		//else
	}
	else if(operation=="denyProof"){
		var approveWhom=req.body.d.approveWhom;
		var approveType=req.body.d.approveType;
		var approveImgName=req.body.d.approveImgName;
		var client=utility.prepareDb();
		if(approveType=="identitycard"){
			//身份证
			var queryString="update credits set "+approveType+"=-1,level=0,identity=0"+" where username='"+approveWhom+"'";
			//var queryString="update credits set "+approveType+"=-1 where username='"+approveWhom+"'";
			client.query(queryString,function(e,r){
				if(e){
					throw e;
				}
				// var fsUrl="C:\Users\357570\WebstormProjects\web\uploads\proofPic\"                  +approveType+        "\"+approveWhom+"\";
				var fsUrl="./uploads/proofPic/"+approveType+"/"+approveWhom+"/"+approveImgName;
				fs.unlink(fsUrl,function(e){
					if(e){
						throw e;
					}
				});
				res.send("1");
				client.end();
			});
		} else {
			//非身份证
			var queryString="update credits set "+approveType+"=-1 where username='"+approveWhom+"'";
			client.query(queryString,function(e,r){
				if(e){
					throw e;
				}
				var queryString="select pending from credits where username='"+approveWhom+"'";
				client.query(queryString,function(e,r){
					if(e){
						throw e;
					}
					//var fsUrl="./uploads/proofPic/"+approveType+"/"+approveWhom+"/car.jpg";
					//var fsUrl="./uploads/proofPic/"+approveType+"/"+approveWhom+"/";
					var fsUrl="./uploads/proofPic/"+approveType+"/"+approveWhom+"/"+approveImgName;
					fs.unlink(fsUrl,function(e){
						if(e){
							throw e;
						}
					});
					var pending = r[0]["pending"];
					pending = eval("("+pending+")");
					if(pending.length !== 0){
						for(var i=0;i<pending.length;i++){
							if(pending[i]===approveType){
								pending.splice(i,1);
								pending=JSON.stringify(pending);
								var queryString="update credits set pending='"+pending+"where username='"+approveWhom+"'";
								client.query(queryString,function(e){
									if(e){
										throw e;
										client.end();
									}
								});
							}
						}
					}
					res.send("1");
				});
			});
		}
	}
};


