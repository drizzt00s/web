module.exports.prepareDb = function(){
	var Client = require("mysql").Client;
	var client = new Client();
	client.user = "root";
	client.password = "5611559w";
	client.query("USE user");
	return client;
};

module.exports.defaultProfile = function(){
    //用户无头像时，用问号图片
    var defaultProfile = '/images/default/unknown.png';
    return defaultProfile
};

module.exports.userProfile = function(username, profileWithoutPath){
    var profile = '/uploads/pic/' + username + '/' + profileWithoutPath; //为图片加上路径
    return profile;
};

module.exports.userAvatarLength = function(avatarString){
    //用户有几张照片
    var avatarsLength;
    if(avatarString.length > 0){
        var avatarsLength = (eval("("+ avatarString +")"))['con'].length;
    }
    return avatarsLength
};

module.exports.loopQuery = function(collection,res){
    if(collection){
        var client = utility.prepareDb();
        var storeNew = [];
        var indexFlag = 0;
        thisQuery();
        function thisQuery(){
            if(indexFlag == collection.length){
                loopImg(collection,storeNew);
                //res.send(storeNew);
            }
            if(collection[indexFlag]){
                var queryString="select * from d where account='"+collection[indexFlag]+"'";
                client.query(queryString,function(e,d){
                    if(e){
                        throw e;
                    }
                    var storeEachOnline={};
                    var falseName = d[0]["falseName"];
                    var xinzuo = d[0]["sign"];
                    storeEachOnline["falseName"] = falseName;
                    storeEachOnline["xinzuo"] = xinzuo;
                    storeNew.push(storeEachOnline);
                    indexFlag++;
                    thisQuery();
                });
            }
        }
        function loopImg(o,existingArray){
            for(var i = 0; i < o.length; i++){
                var picUrl = "./web/uploads/pic/"+o[i];
                var ifIconExists=fs.existsSync(picUrl);
                if(ifIconExists){
                    var picArray=fs.readdirSync("./web/uploads/pic/"+o[i]);
                    var picArray=picArray[0];
                    existingArray[i]["pic"] = "../uploads/pic/" +o[i]+"/"+picArray;
                } else {
                    console.log("A");
                    existingArray[i]["pic"] = "../uploads/pic/default/unknown.png"
                }
            }
            res.send(existingArray);
        }
    }
};

module.exports.searchLoverQuery = function(o){
	if(searchType == 1){
		//简单搜索,简单搜索只和gender,avatar,pLocation,cLocation,birthYear这几个字段
		var searchGenderQuery = o.searchGenderQuery;
		var searchYearQuery1 = o.searchYearQuery1;
		var searchYearQuery2 = o.searchYearQuery2;
		var searchProvinceQuery = o.searchProvinceQuery;
		var searchCityQuery= o.searchCityQuery;
		var searchHasPictureQuery = o.searchHasPictureQuery;
		if(searchCityQuery == "任意" && searchProvinceQuery != "任意"){
			if(searchHasPictureQuery == "not null"){
				//有照片
				var searchLoverQuery="SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+"AND pLocation='"+searchProvinceQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'"+" AND avatar is not null";
			} else {
				var searchLoverQuery="SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+"AND pLocation='"+searchProvinceQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'";
			}
		}
		else if(searchProvinceQuery == "任意"&&searchCityQuery=="任意"){
			if(searchHasPictureQuery == "not null"){
				var searchLoverQuery = "SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'"+" AND avatar is not null";
			} else {
				var searchLoverQuery = "SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'";
			}
		} else {
			if(searchHasPictureQuery == "not null"){
				var searchLoverQuery = "SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+"AND pLocation='"+searchProvinceQuery+"'"+" AND cLocation='"+searchCityQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'"+" AND avatar is not null";
			} else {
				var searchLoverQuery = "SELECT * FROM d WHERE gender='"+searchGenderQuery+"'"+"AND pLocation='"+searchProvinceQuery+"'"+" AND cLocation='"+searchCityQuery+"'"+" AND birthYear>="+searchYearQuery2+"&&birthYear<='"+searchYearQuery1+"'";
			}
		}
		return searchLoverQuery; 
	} 
};

module.exports.removeRedundant = function(o){
    var storeNewO=[];
    for(var i=0;i< o.length;i++){
        if(i!=0){
            var isIn=detect(o[i]);
            if(isIn){
                storeNewO.push(o[i]);
                continue;
            }
            else{
                continue;
            }
        }
        storeNewO.push(o[i]);
    }
    function detect(item){
        var legal=true;
        for(var i=0;i<storeNewO.length;i++){
            if(storeNewO[i]===item){
                legal=false;
            }
        }
        return legal;
    }
    return storeNewO;
};


