var utility = require('utlity.js');
var user = require("moduleUser");



exports.showAllUsers = function(req,res){
        var client = utility.prepareDb();
        var queryString="SELECT account,falseName,age,height,address,profile FROM d";
        client.query(queryString,function(error,result){
            if(error){
                throw error;
            }
            res.json({allUserInfo:result});
        })
};

exports.showUserPic = function(req,res){
    var checkIsShowPic=req.query.isShowPic;//值:getMsg;这个值何用?
    var userAccount=req.session.username;
    var queryRemainingPic="SELECT * FROM d WHERE account="+"'"+userAccount+"'";
    var Client =require("mysql").Client;
    var client =new Client();
    client.user="root";
    client.password="5611559w";
    client.query("USE user");
    if(checkIsShowPic==1){
        client.query(queryRemainingPic,function(error,result){
               if(error){
                   throw error;
               }
            var picObjectString=result[0].avatar;
            var picJson=eval("("+picObjectString+")");
            var checkIfHasPic=picJson.con.length;
            if(checkIfHasPic==0){
               res.send("none");
               client.end();
            }
            else{
               res.json({userStoredPic:picObjectString});
               client.end();
            }
         })
    }
    else if(checkIsShowPic=="getMsg"){
    //收件箱逻辑
     var getUsername=req.query.username;
     var queryString="SELECT * FROM d WHERE account="+"'"+getUsername+"'";
     client.query(queryString,function(error,result){
        if(error){
             throw error;
        }
         var resultProcessed1=result[0]["msgAsyn"];//string
         var resultProcessed2=eval("("+resultProcessed1+")");//json
         res.json({dataServer:resultProcessed2});
      });
    }
    else if(checkIsShowPic=="showAllUserPics"){
      //如果进这里的话，意味着需要查出所有的或者是特定条件的所有用户，所以不需要知道用户名
      //在主页中显示db中所有用户的信息
        var queryString="SELECT * FROM d";
        client.query(queryString,function(error,result){
                if(error){
                    throw error;
                }

                 res.json({allUserInfo:result});
            })

    }
    else{
        client.query(queryRemainingPic,function(error,result){
            if(error){
                throw error;
            }
            var picObjectString=result[0].avatar;
            var picJson=eval("("+picObjectString+")");
            if(!picJson){
                allowedPicLength=12;
            }
            else{
                var picJsonLength=picJson["con"].length;
                var allowedPicLength=12-picJsonLength;
            }
            res.json({ remainingPic: allowedPicLength })
            client.end();
        })
    }

};


exports.login = function(reg,res){
    var account = reg.body.username;
    var pass = reg.body.pass;
    var User = user.user;
    var userInstance = new User();
    userInstance.loginCheck(account,pass,reg,res);
};

exports.getLogin = function(reg,res){
    res.render("./login/login.ejs",{title:"login"});
}