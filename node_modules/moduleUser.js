var commons = require('serverCommon.js');
var Errors = require('error.js');

function createHtml(length,type,minValue){
 if(type==1){
    var insertedHtml=[];
    insertedHtml.length=length;
    for(var i=0;i<length;i++){
        insertedHtml[i]=minValue;
        minValue++
    }
 }
    return insertedHtml;
}
var registerHtml1=createHtml(51,1,1950);
var registerHtml2=createHtml(61,1,140);
//for register
var registerHtml3=createHtml(81,1,40);

var registerHtml4=["鼠","牛","虎","兔","龙","蛇","马","羊","猴","鸡","狗","猪"];
var registerHtml5=["白羊座", "金牛座", "双子座", "巨蟹座", "狮子座", "处女座" ,"天秤座", "天蝎座" ,"射手座", "摩羯座", "水瓶座"," 双鱼座"];
var registerHtml6=["请选择","销售","客户服务","计算机/互联网","通信/电子","生产/制造","物流/仓储","商贸/采购","人事/行政","高级管理","广告/市场","传媒/艺术","生物/制药","医疗/护理","金融/保险/银行","建筑/房地产","咨询/顾问","法律","财会/审计","教育/科研","服务业","交通运输","政府机构","军人/警察","农林牧渔","自由职业","在校学生","待业","其他职业"];
//for edit
function User(username,pass,checkPass,indentityCard,postCode,mobile,phone,province,falseName,marriageStatus,gender,email,trueName,personalWebsite,height,birthdayProcessed,education,address,name,weight,horoscope,sign,bloodType,race,religion,selfintri,ifSmoking,ifDrinking,ifHasCar,cooks,houseKeeping,saving,whenToMarrige,whenHasChild,liveWithParents,mainCosts,mainDateType,jobInfo1,jobInfo,jobOverview,companyInfo,eventLoved,sportsLoved,musicLoved,movieLoved,foodLoved,locationLoved,petLoved,hobby,parentsStatus,siblingsStatus,birthPlaceInfo,liveWithParents2,talkAboutFamily,birthPlaceInfoCity,monthIncome,ifHasChildren,housingCondition,avatar,birthYear,provinceLocation,cityLocation,age,intHeight,intEducation){
this.username=username;
this.pass=pass;
this.checkPass=checkPass;
this.indentityCard=indentityCard;
this.postCode=postCode;
this.mobile=mobile;
this.phone=phone;
this.adress=province;
this.userAdress=address;
this.falseName=falseName;
this.marriageStatus=marriageStatus;
this.gender=gender;
this.email=email;
this.trueName=trueName;
this.personalWebsite=personalWebsite;
this.height=height;
this.birthdayDetail=birthdayProcessed;
this.education=education;
//data for register
this.name=name;
this.weight=weight;
this.sign=sign;
this.horoscope=horoscope;
this.bloodType=bloodType;
this.race=race;
this.religion=religion;
this.selfintri=selfintri;
//data for editing profile1
this.ifSmoking=ifSmoking;
this.ifDrinking=ifDrinking;
this.ifHasCar=ifHasCar;
this.cooks=cooks;
this.houseKeeping=houseKeeping;
this.saving=saving;
this.whenToMarrige=whenToMarrige;
this.whenHasChild=whenHasChild;
this.liveWithParents=liveWithParents;
this.mainCosts=mainCosts;
this.mainDateType=mainDateType;
//data for editing profile2
this.jobInfo1=jobInfo1;
this.jobInfo=jobInfo;
this.jobOverview=jobOverview;
this.companyInfo=companyInfo;
//data for editing profile3
this.eventLoved=eventLoved;
this.sportsLoved=sportsLoved;
this.musicLoved=musicLoved;
this.movieLoved=movieLoved;
this.foodLoved=foodLoved;
this.locationLoved=locationLoved;
this.petLoved=petLoved;
//data for editing profile4
this.hobby=hobby;
//data for editing profile5
this.parentsStatus=parentsStatus;
this.siblingsStatus=siblingsStatus;
this.birthPlaceInfo=birthPlaceInfo;
this.liveWithParents2=liveWithParents2;
this.talkAboutFamily=talkAboutFamily;
this.birthPlaceInfoCity=birthPlaceInfoCity;
//data for editing profile6
this.monthIncome=monthIncome;
this.ifHasChildren=ifHasChildren;
this.housingCondition=housingCondition;
//data for editBasic1
this.avatar=avatar;
//data for pic,avatar is a string of array
this.birthYear=birthYear;
this.provinceLocation=provinceLocation;
this.cityLocation=cityLocation;
this.age=age;
this.intHeight=intHeight;
this.intEducation=intEducation;
}
User.prototype.createQueryString = function(dbInstance,dbName,tableName,queryType,columnsOfArray,dataOfArray,callBack,userUsername,whichPage){
     var queryString="";
    //db begins
    dbInstance.user="root";
    dbInstance.password="5611559w";
    dbInstance.query("USE "+dbName);
//db ready
 if(queryType==1){
 //queryType==1 is insert
     queryString="INSERT INTO "+tableName+" SET ";
     for(var i=0;i<dataOfArray.length;i++){
         var columnName=columnsOfArray[i];
         var data=dataOfArray[i];
             data="'"+data+"'";
         queryString+=columnName+"="+data+", ";
     }
     queryString=queryString.substring(0,(queryString.length)-2);
     //queryString=(queryString+"WHERE account="+"'"+userUsername+"'");
	 
	 //console.log(queryString);
	 //console.log("!!!!!!!!!!!!!!!!!!!!!!!!");
	 
     //make sure there is one accurate acccount that should be edited

     callBack(queryString,whichPage);
 }
   else if(queryType==2){
     //queryType==2 is update
     queryString="UPDATE "+tableName+" SET ";
     for(var i=0;i<dataOfArray.length;i++){
         var columnName=columnsOfArray[i];
         var data=dataOfArray[i];
         data="'"+data+"'";
         queryString+=columnName+"="+data+", ";
     }
     queryString=queryString.substring(0,(queryString.length)-2);
     queryString=(queryString+"WHERE account="+"'"+userUsername+"'");
     //make sure there is one accurate acccount that should be edited

     console.log(queryString);

     
     callBack(queryString,whichPage);
 }
}
//create a queryString for db query



User.prototype.editUser=function(req,res,whichPageEdited,account){
  if(whichPageEdited==1){
      var Client =require("mysql").Client;
      var client =new Client();
      var name=this.name;
      var weight=this.weight;
      var horoscope=this.horoscope;
      var sign=this.sign;
      var bloodType=this.bloodType;
      var race=this.race;
      var religion=this.religion;
      var selfintri=this.selfintri;
      var columnArray=["name","weight","horoscope","sign","bloodType","race","religion","selfintri"];
      var dataArray=[name,weight,horoscope,sign,bloodType,race,religion,selfintri];
      this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
  }
  if(whichPageEdited==2){
      var Client =require("mysql").Client;
      var client =new Client();
      var ifSmoking=this.ifSmoking;
      var ifDrinking=this.ifDrinking;
      var ifHasCar=this.ifHasCar;
      var cooks=this.cooks;
      var houseKeeping=this.houseKeeping;
      var saving=this.saving;
      var whenToMarrige=this.whenToMarrige;
      var whenHasChild=this.whenHasChild;
      var liveWithParents=this.liveWithParents;
      var mainCostsString=this.mainCosts;
      var mainDateTypeString=this.mainDateType;
      var columnArray=["ifSmoking","ifDrinking","ifHasCar","cooks","houseKeeping","saving","whenToMarrige","whenHasChild","liveWithParents","mainCosts","mainDateType"];
      var dataArray=[ifSmoking,ifDrinking,ifHasCar,cooks,houseKeeping,saving,whenToMarrige,whenHasChild,liveWithParents,mainCostsString,mainDateTypeString];
      this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
  }
    if(whichPageEdited==3){
        var Client =require("mysql").Client;
        var client =new Client();
        var jobInfo1=this.jobInfo1;
        var jobInfo=this.jobInfo;
        var jobOverview=this.jobOverview;
        var companyInfo=this.companyInfo;
        var columnArray=["jobinfo1","jobinfo","joboverview","companyinfo"];
        var dataArray=[jobInfo1,jobInfo,jobOverview,companyInfo];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
    }
    if(whichPageEdited==4){
        var Client =require("mysql").Client;
        var client =new Client();
        var eventLoved=this.eventLoved;
        var sportsLoved=this.sportsLoved;
        var musicLoved=this.musicLoved;
        var movieLoved=this.movieLoved;
        var foodLoved=this.foodLoved;
        var locationLoved=this.locationLoved;
        var petLoved=this.petLoved;
        var columnArray=["eventloved","sportsloved","musicloved","movieloved","foodloved","locationloved","petloved"];
        var dataArray=[eventLoved,sportsLoved,musicLoved,movieLoved,foodLoved,locationLoved,petLoved];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
    }
    if(whichPageEdited==5){
        var Client =require("mysql").Client;
        var client =new Client();
        var hobby=this.hobby;
        var columnArray=["hobby"];
        var dataArray=[hobby];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
    }
    if(whichPageEdited==6){
        var Client =require("mysql").Client;
        var client =new Client();
        var parentsStatus=this.parentsStatus;
        var siblingsStatus=this.siblingsStatus;
        var birthPlaceInfo=this.birthPlaceInfo;
        var liveWithParents2=this.liveWithParents2;
        var talkAboutFamily=this.talkAboutFamily;
        var birthPlaceInfoCity=this.birthPlaceInfoCity;
        var columnArray=["parentstatus","siblingsstatus","birthplaceinfo","livewithparents2","talkaboutfamily","birthplaceinfocity"];
        var dataArray=[parentsStatus,siblingsStatus,birthPlaceInfo,liveWithParents2,talkAboutFamily,birthPlaceInfoCity];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
    }
    if(whichPageEdited=="editBasic1"){
        var Client =require("mysql").Client;
        var client =new Client();
        var editFalseName=this.falseName;
        var editMobile=this.mobile;
        var editEmail=this.email;
        var editBirthPlaceInfo=this.birthPlaceInfo;
        var editBirthPlaceInfoCity=this.birthPlaceInfoCity;
        // data for update
        var monthIncome= this.monthIncome;
        var ifHasChild=this.ifHasChildren;
        var housingCondition=this.housingCondition;
        //data for insert
        var columnArray=["falseName","mobile","email","birthplaceinfo","birthplaceinfocity","monthincome","ifhaschildren","housingcondition"];
        var dataArray=[editFalseName,editMobile,editEmail,editBirthPlaceInfo,editBirthPlaceInfoCity,monthIncome,ifHasChild,housingCondition];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);

    }
    if(whichPageEdited=="editPic"){
        var Client =require("mysql").Client;
        var client =new Client();
        var avatar=this.avatar;
        // data for editing pic
        var columnArray=["avatar"];
        var dataArray=[avatar];
        this.createQueryString(client,"user","d",2,columnArray,dataArray,finalEdit,account,whichPageEdited);
    }
    function finalEdit(queryString,whichPage){
        client.query(queryString,function(error){
            if(error){
                throw error;
                client.end();
            }
            if(whichPage == 1){
                //res.redirect("./../edit2.ejs");
                res.send({d:true});
            }
            else if(whichPage == 2){
                //res.redirect("./../edit3.ejs");
                res.send({d:true});
            }
            else if(whichPage == 3){
               // res.redirect("./../edit4.ejs");
               res.send({d:true});
            }
            else if(whichPage == 4){
                //res.redirect("./../edit5.ejs");
                res.send({d:true});
            }
            else if(whichPage == 5){
                //res.redirect("./../edit6.ejs");
                res.send({d:true});
            }
            else if(whichPage == 6){
                //res.redirect("./../editPic.ejs");
                res.send({d:true});
            }
            else if(whichPage == "editBasic1"){
               // res.redirect("/user/edit1.ejs");
               res.send({d:true});

            }
            else if(whichPage == "editPic"){
                res.redirect("./../editPic.ejs");
            }
        })
    }
}
//edit profile





User.prototype.loginCheck = function(checkUsername,checkPass,reg,res){
    var storeQueryResult={};
    var accountErrorMsg="";
    var passErrorMsg="";
    var crypto=require("crypto");
    var md5=crypto.createHash("md5");
    var passwordProcessed=md5.update(checkPass).digest("base64");
    //db begins
    var Client =require("mysql").Client;
    var client =new Client();
    client.user="root";
    client.password="5611559w";
    client.query("USE user");
//db ready
    var queryString="SELECT * FROM d WHERE account="+"'"+checkUsername+"'";
    client.query(queryString,function cBack(error,result,fields){
          if(error){
              throw error;
          }
        var checkResultLength=result.length;
        if(checkResultLength==0){

          res.send({
                success:false,
                msg:Errors.getErrorMsg('userNotExist'),
                errorColumn:'username'
          });
        }
        //用户名不存在
        else{
            var queryString2="SELECT * FROM d WHERE account="+"'"+checkUsername+"'"+"AND password="+"'"+passwordProcessed+"'";
            client.query(queryString2,function(error,result,fields){
                if(error){
                  throw error;
                }
                if(result.length==0){
                    res.send({
                        success:false,
                        msg:Errors.getErrorMsg('passwordWrong'),
                        errorColumn:'password'
                    });
                    //密码不正确
                }
                else{
                    var userMobile=result[0].mobile;
                    var userFalseName=result[0].falseName;
                    var uid = result[0]['personid'];
                    var gender = result[0]['gender'];


                    reg.session.username=checkUsername;
                    reg.session.userFalseName=userFalseName;
                    reg.session.userMobile=userMobile;
                    //登录成功后在session中存储3个值username,userFalseName,userMobile
                    storeQueryResult["accResult"]=accountErrorMsg;
                    storeQueryResult["passResult"]=passErrorMsg;
					storeQueryResult["falseName"]=userFalseName;
                    res.cookie("username",checkUsername);
					res.cookie("falseName",userFalseName);
                    res.cookie("uid", uid);
                    res.cookie("gender", gender);
                    

                    //登录成功之后给浏览器发送用户名，存在cookie
                    res.send({
                        success:true,
                        msg:'login success',
                        uid:uid,
                        username:checkUsername,
                        falseName:userFalseName,
                        gender:gender
                    });
					var loginTime=commons.getCurrentTime();
					//loginTime=loginTime.toLocaleDateString(); //当前时间,是否是中文要看服务器,以后可能会修改
					var thisCurrentTime=(new Date()).getTime();
					//登录的时候再添加一个字段loginTimeInt,记录登录时间的毫秒值 用处是给搜索出来的结果按照时间排序
                    var queryChangeOnlineStatus="UPDATE d SET isonline=1,lastLogin='"+loginTime+"'"+",loginTimeInt='"+thisCurrentTime+"'"+"where account='"+checkUsername+"'";
                    client.query(queryChangeOnlineStatus,function(error){
                          if(error){
                                throw error;
                          }
                        })
                    //登录成功
                }
            })
        }
        //else
    });
};
/*===============================================sign up=========================================*/
User.prototype.checkIfUserExist = function(reg,res){
    var _this=this;
//db begins
    var Client =require("mysql").Client;
    var client =new Client();
    client.user="root";
    client.password="5611559w";
    client.query("USE user");
//db ready
    var account=this.username;
    var pass=this.pass;
    var checkPass=this.checkPass;
    var address=this.adress;
    var userAddressArray=address.split(" ");
    var userAddressProvince=userAddressArray[0];
    var userAddressCity=userAddressArray[1]+" "+userAddressArray[2];
    var falseName=this.falseName;
    //var gender=this.gender;
    var birthday=this.birthdayDetail;
    var mail=this.email;
    var trueName=this.trueName;
    var indentityCard=this.indentityCard;
    var userAddress=this.userAdress;
    var postCode=this.postCode;
    var mobile=this.mobile;
    var phone=this.phone;
    var website=this.personalWebsite;
    var marriageStatus=this.marriageStatus;
    var education=this.education;
    var height=this.height;
	  var age=this.age;
    var intHeight=this.intHeight;
    var intEducation=this.intEducation;
//get register data
    var account=this.username;
    var pass=this.pass;
    var checkPass=this.checkPass;
    var queryString = "SELECT * FROM d WHERE account="+"'"+account+"'";
    client.query(queryString,function cBack(error,results,fields){
        if(error){
            throw error;
        }
        var queryResult=results.length;
        if(queryResult != 0){ 
            var returnData = {};

            returnData.success = false;
            returnData.errorMsg = Errors.getErrorMsg('duplicateAccount');
            returnData.errorType = 'username';

            res.send(returnData);
        }
        else{
            _this.save(reg,res,account);
        }
    });
}

/*===============================================注册验证=========================================*/
User.prototype.save=function(reg,res,userAccount){
    var account=this.username;
    var pass=this.pass;
    var indentityCard=this.indentityCard;
    var postCode= this.postCode;
    var mobile=this.mobile;
    var phone=this.phone;
    var adress=this.adress;
    var userAdress=this.userAdress;
    var falseName=this.falseName;
    var marriageStatus= this.marriageStatus;
    var gender= this.gender;
    var email=this.email;
    var trueName=this.trueName;
    var personalWebsite=this.personalWebsite;
    var height= this.height;
    var birthdayDetail= this.birthdayDetail;
    var education=this.education;
    var birthYear=this.birthYear;
    var provinceLocation=this.provinceLocation;
    var cityLocation=this.cityLocation;
    var age=this.age;
    var intHeight=this.intHeight;
    var intEducation=this.intEducation;
  //collect data
    var Client =require("mysql").Client;
    var client =new Client();
 //create a db instance
    var crypto=require("crypto");
    var md5=crypto.createHash("md5");
    var passwordProcessed=md5.update(pass).digest("base64");
    var columnArray=["account","password","province","falseName","gender","birthday","email","trueName","indentityCard","address","mobile","phone","personalWebsite","marriageStatus","education","height","postCode","birthYear","pLocation","cLocation","age","intHeight","intEducation"];
    var dataArray=[account,passwordProcessed,adress,falseName,gender,birthdayDetail,email,trueName,indentityCard,userAdress,mobile,phone,personalWebsite,marriageStatus,education,height,postCode,birthYear,provinceLocation,cityLocation,age,intHeight,intEducation];
    this.createQueryString(client,"user","d",1,columnArray,dataArray,finalSave);
    function finalSave(queryString){
        client.query(queryString,function(error){
            if(error){
                throw error;
            }
            client.end();
            reg.session.username = userAccount;
            reg.session.userFalseName = falseName;
            reg.session.userMobile = mobile;
            //username,userFalseName,userMobile此处何用?

            res.cookie("username",account);
            res.cookie("falseName",falseName);

           //设置session
		    var signUpTime=commons.getCurrentTime();
		    var queryStringFinal="update d set isOnline=1,lastLogin='"+signUpTime+"'"+"where account='"+userAccount+"'"; //added on 2013/10/23
			//console.log(queryStringFinal);
            var clinet=prepareDb();
			clinet.query(queryStringFinal,function(e){
			  if(e){
			    throw e;
			  }
			  var queryStringCredits="insert into credits (uploaded,identitycard,income,drive,gangao,housing,level,identity,pending,username) values(0,-1,-1,-1,-1,-1,0,0,'[]','"+userAccount+"')";
			  clinet.query(queryStringCredits,function(e){
			    if(e){
				  throw e;
				}


                 var returnData = {};
                 returnData.success = true;
                 returnData.errorMsg = 'success';
                 returnData.errorType = '';
                 returnData.username = userAccount;
                 returnData.falseName = falseName;
                 
                 res.send(returnData);
			  });
			});
        });
    }
}
//save


/*===============================================注册成功=========================================*/
function prepareDb(){
  var Client=require("mysql").Client;
  var client=new Client();
  client.user="root";
  client.password="5611559w";
  client.query("USE user");
  return client;
}
exports.user = User;









